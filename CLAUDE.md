# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Rust wrapper around the [timelib](https://github.com/derickr/timelib) C library (used by PHP and MongoDB). The project uses FFI bindings generated by bindgen to expose timelib's date/time parsing functionality to Rust.

## Key Architecture

### Build System (build.rs)

The build process is complex and involves:

1. **FFI Bindings Generation**: Uses `bindgen` to generate Rust bindings from `ext/timelib/timelib.h` and `shim/shim.h`
2. **C Code Compilation**: Uses `cc` crate to compile timelib C sources and a custom shim layer
3. **re2c Generated Files**: Two critical parser files (`parse_date.c` and `parse_iso_intervals.c`) can be:
   - Generated at build time if `re2c` feature is enabled (requires re2c tool installed)
   - Used from `pregenerated/` directory by default (no dependencies needed)

### Components

- **ext/timelib/**: Git submodule containing the upstream timelib C library
- **ext/hashmap.h/**: Git submodule for hashmap implementation used by the shim layer
- **shim/**: Custom C wrapper (`shim.c`/`shim.h`) that adds timezone caching via hashmap (`timelib_tz_get_wrapper_cached`)
- **src/lib.rs**: Main Rust API exposing `strtotime()` and `Timezone` types
- **src/internal.rs**: FFI bindings (includes generated code from OUT_DIR)
- **pregenerated/**: Pre-generated re2c outputs for distribution (avoids requiring re2c installation)

### Platform-Specific Build Flags

- **Non-Windows**: Links against `libm`, includes debug flags, stack protector, pedantic warnings
- **Windows**: Defines `HAVE_IO_H` instead of Unix headers
- **musl/Alpine Linux**: Uses `-g` flag instead of `-ggdb3` for compatibility with musl libc; uses pregenerated bindings to avoid bindgen issues with Alpine's statically-linked Rust

## Common Commands

### Building and Testing

```bash
# Standard build (uses pregenerated re2c files)
cargo build

# Run all tests
cargo test

# Build with re2c generation (requires re2c installed)
cargo test --features re2c

# Build for Alpine Linux (musl target)
# On Alpine Linux, install build dependencies first:
apk add musl-dev
cargo build
cargo test

# The library automatically detects musl targets and uses pregenerated
# bindings to avoid bindgen dependency issues with Alpine's statically-linked Rust.

# Lint
cargo fmt --all -- --check

# Clippy
cargo clippy
```

### Submodule Management

```bash
# Initial clone with submodules
git clone --recurse-submodules https://github.com/westy92/timelib-rust

# Update existing checkout
git submodule init && git submodule update

# Update submodule to latest upstream
git submodule update --remote
```

### Updating Timelib Version

When updating the timelib submodule:

1. Update submodule: `git submodule update --remote`
2. Regenerate re2c files:
   ```bash
   cd ext/timelib/
   make parse_date.c parse_iso_intervals.c
   cp parse_date.c ../../pregenerated/
   cp parse_iso_intervals.c ../../pregenerated/
   ```
3. Update the expected version in `src/lib.rs` test `timezone_db_version()`

### Publishing

```bash
# Dry run
cargo publish --dry-run

# Actual publish
cargo publish
```

## Important Notes

- The shim layer provides timezone caching to avoid repeatedly parsing timezone files
- Bindings are regenerated on every build via build.rs (except for musl targets which use pregenerated bindings)
- The `re2c` feature is optional; pregenerated files make the crate buildable without extra tools
- Must maintain git submodules (timelib and hashmap.h) for builds to work
- **Alpine Linux/musl**: The library is fully compatible with musl libc (Alpine Linux). The build system automatically detects musl targets and:
  - Uses pregenerated bindings instead of running bindgen (avoids issues with Alpine's statically-linked Rust)
  - Adjusts compiler flags (`-g` instead of `-ggdb3`)
  - Compiles C code statically into the binary (no external shared libraries needed besides `libm`)
  - On Alpine Linux, simply use standard `cargo build` and `cargo test` commands after installing `musl-dev`
